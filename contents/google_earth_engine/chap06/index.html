<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第6章：土地利用をマッピング | jkatagi&#39;s pages</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.9047b579.css" as="style"><link rel="preload" href="/assets/js/app.db0e00cd.js" as="script"><link rel="preload" href="/assets/js/10.3b01200f.js" as="script"><link rel="prefetch" href="/assets/js/11.0e896df5.js"><link rel="prefetch" href="/assets/js/12.4845ef52.js"><link rel="prefetch" href="/assets/js/13.f29fa303.js"><link rel="prefetch" href="/assets/js/14.3464f1ab.js"><link rel="prefetch" href="/assets/js/15.e2d9f619.js"><link rel="prefetch" href="/assets/js/16.ef0ed2df.js"><link rel="prefetch" href="/assets/js/17.5d104749.js"><link rel="prefetch" href="/assets/js/2.3e3f7938.js"><link rel="prefetch" href="/assets/js/3.24eca8be.js"><link rel="prefetch" href="/assets/js/4.186a2c41.js"><link rel="prefetch" href="/assets/js/5.5c67711d.js"><link rel="prefetch" href="/assets/js/6.20e7ec66.js"><link rel="prefetch" href="/assets/js/7.681a0ced.js"><link rel="prefetch" href="/assets/js/8.53adf7e1.js"><link rel="prefetch" href="/assets/js/9.3823a06b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9047b579.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">jkatagi's pages</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/contents/google_earth_engine/" class="nav-link router-link-active">Google Earth Engine入門-ゼロから始める衛星画像解析-</a></div><div class="nav-item"><a href="/contents/paper_review/" class="nav-link">論文メモ</a></div><div class="nav-item"><a href="https://github.com/jkatagi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/contents/google_earth_engine/" class="nav-link router-link-active">Google Earth Engine入門-ゼロから始める衛星画像解析-</a></div><div class="nav-item"><a href="/contents/paper_review/" class="nav-link">論文メモ</a></div><div class="nav-item"><a href="https://github.com/jkatagi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>第6章：土地利用をマッピング</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/contents/google_earth_engine/chap06/#土地被覆図とは" class="sidebar-link">土地被覆図とは</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/contents/google_earth_engine/chap06/#教師なし分類" class="sidebar-link">教師なし分類</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/contents/google_earth_engine/chap06/#まとめ" class="sidebar-link">まとめ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/contents/google_earth_engine/chap06/#練習問題" class="sidebar-link">練習問題</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/contents/google_earth_engine/chap06/#コラム：大気補正・地形補正" class="sidebar-link">コラム：大気補正・地形補正</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/contents/google_earth_engine/chap06/#コラム：精度評価の話" class="sidebar-link">コラム：精度評価の話</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="第6章：土地利用をマッピング"><a href="#第6章：土地利用をマッピング" aria-hidden="true" class="header-anchor">#</a> 第6章：土地利用をマッピング</h1> <p>本章では土地利用を記述した地図である土地利用・土地被覆図（以下，まとめて土地被覆図）を作成していきます。
この地図は様々な研究の入力データとして使われている重要な地図です。
実際に作成してみることで，その問題点を探ってみましょう。</p> <h2 id="土地被覆図とは"><a href="#土地被覆図とは" aria-hidden="true" class="header-anchor">#</a> 土地被覆図とは</h2> <p>土地利用図は先程も述べましたが、どのように土地が利用されているかを記述した地図です。
この地図は目的によって記述してあるカテゴリが異なりますが、一般的に10数カテゴリが多いです。
土地利用図は、手で作成することも可能です。
その一例として中学の地理で習った地形図が挙げられます。
地形図には果樹園や水田などの土地利用を記号で表し、マッピングしています。</p> <p>このように土地被覆図は手で作成することも可能ではありますが、例えば地球全体の土地被覆を地図にしてと言われたら、ちょっと尻込みしてしまいます。
仮にやる気があって手で作成しようと思い立っても、土地被覆は日々変化していくので、作成している間にまた作り直さなければいけません。</p> <p>そこで人工衛星の登場です。
人工衛星は度々説明していますが、その特徴として全世界をまんべんなく、定期的に観測することが出来ます。
人工衛星で観測された情報をうまく活用することにより、土地被覆図を少ない労力で定期的に作成することが出来るのです。
実際にJAXAや国土地理院では人工衛星の観測画像（+
それ以外の情報）を活用し、土地被覆図を作成・公開しています。
一般に土地被覆図を衛星画像から作成する場合、機械学習の手法を用います。
機械学習とは、（書きかけ）
機械学習は教師なし分類と教師あり分類の2つに分けられます。
教師なし分類は教師情報（ここではその土地が何かを人間が教える情報）を用いずに分類する手法です。
一方で教師あり分類は教師情報を用いて分類する手法です。</p> <p>まずは教師なし分類から試していきましょう。</p> <h2 id="教師なし分類"><a href="#教師なし分類" aria-hidden="true" class="header-anchor">#</a> 教師なし分類</h2> <p>Sentinel-2衛星を用いて土地被覆図を作成していきます。
Sentinel-2は光学衛星なのでまずは雲の影響を取り除かなければなりません。
GEEのExamplesの中に，CloudMasking → Sentinel2という例があります。
このスクリプトを改造していきましょう。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Load Sentinel-2 TOA reflectance data.</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'COPERNICUS/S2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Function to mask clouds using the Sentinel-2 QA band.</span>
<span class="token keyword">function</span> <span class="token function">maskS2clouds</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> qa <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'QA60'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Bits 10 and 11 are clouds and cirrus, respectively.</span>
  <span class="token keyword">var</span> cloudBitMask <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> cirrusBitMask <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Both flags should be set to zero, indicating clear conditions.</span>
  <span class="token keyword">var</span> mask <span class="token operator">=</span> qa<span class="token punctuation">.</span><span class="token function">bitwiseAnd</span><span class="token punctuation">(</span>cloudBitMask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>
             qa<span class="token punctuation">.</span><span class="token function">bitwiseAnd</span><span class="token punctuation">(</span>cirrusBitMask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the masked and scaled data.</span>
  <span class="token keyword">return</span> image<span class="token punctuation">.</span><span class="token function">updateMask</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Map the function over one year of data and take the median.</span>
<span class="token keyword">var</span> composite <span class="token operator">=</span> s2<span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span><span class="token string">'2016-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2016-12-31'</span><span class="token punctuation">)</span>
                  <span class="token comment">// Pre-filter to get less cloudy granules.</span>
                  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>ee<span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token string">'CLOUDY_PIXEL_PERCENTAGE'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>maskS2clouds<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">median</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">140.05</span><span class="token punctuation">,</span> <span class="token number">36.05</span><span class="token punctuation">,</span> <span class="token number">140.40</span><span class="token punctuation">,</span> <span class="token number">36.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Display the results.</span>
Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">140.25</span><span class="token punctuation">,</span> <span class="token number">36.12</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>composite<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>bands<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'B3'</span><span class="token punctuation">,</span> <span class="token string">'B2'</span><span class="token punctuation">,</span> <span class="token string">'B1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> min<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>対象領域の追加と緯度経度の変更以外はGEEのExampleのままです。
軽く説明をしていきます。
5行目でSentinel-2の雲マスク処理関数を定義しています。
Sentinel-2ではQA60というバンドに雲の情報が入っているようです。 10 Bit (=
1024)，11 Bit（= 2048）の値を取るときが雲ということです。 9,
10行目では1024, 2048という数字を変数に代入しています。
そして13行目でQA60が10
Bitでも11Bitでもないときに1（＝雲がない）を，それ以外を0（＝雲）としています。
17行目では各バンドの値を10000で割ることで0から1へとスケールさせています。
21行目ではまずはじめに日付でフィルターをし，次に雲被覆率が20%以上のものを選び，そして先程定義した関数を適用し，最後に中央値を取っています。
27行目からはいつもの処理を行って可視化をしています。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Load Sentinel-2 TOA reflectance data.</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'COPERNICUS/S2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Function to mask clouds using the Sentinel-2 QA band.</span>
<span class="token keyword">function</span> <span class="token function">maskS2clouds</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> qa <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'QA60'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Bits 10 and 11 are clouds and cirrus, respectively.</span>
  <span class="token keyword">var</span> cloudBitMask <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> cirrusBitMask <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Both flags should be set to zero, indicating clear conditions.</span>
  <span class="token keyword">var</span> mask <span class="token operator">=</span> qa<span class="token punctuation">.</span><span class="token function">bitwiseAnd</span><span class="token punctuation">(</span>cloudBitMask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>
             qa<span class="token punctuation">.</span><span class="token function">bitwiseAnd</span><span class="token punctuation">(</span>cirrusBitMask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the masked and scaled data.</span>
  <span class="token keyword">return</span> image<span class="token punctuation">.</span><span class="token function">updateMask</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Map the function over one year of data and take the median.</span>
<span class="token keyword">var</span> composite <span class="token operator">=</span> s2<span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span><span class="token string">'2016-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2016-12-31'</span><span class="token punctuation">)</span>
                  <span class="token comment">// Pre-filter to get less cloudy granules.</span>
                  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>ee<span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token string">'CLOUDY_PIXEL_PERCENTAGE'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>maskS2clouds<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">median</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  
<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">140.05</span><span class="token punctuation">,</span> <span class="token number">36.05</span><span class="token punctuation">,</span> <span class="token number">140.40</span><span class="token punctuation">,</span> <span class="token number">36.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> input <span class="token operator">=</span> composite<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Make the training dataset.</span>
<span class="token keyword">var</span> training <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  region<span class="token punctuation">:</span> roi<span class="token punctuation">,</span>
  scale<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  numPixels<span class="token punctuation">:</span> <span class="token number">50</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Instantiate the clusterer and train it.</span>
<span class="token keyword">var</span> clusterer <span class="token operator">=</span> ee<span class="token punctuation">.</span>Clusterer<span class="token punctuation">.</span><span class="token function">wekaKMeans</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">train</span><span class="token punctuation">(</span>training<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Cluster the input using the trained clusterer.</span>
<span class="token keyword">var</span> result <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span>clusterer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Display the results.</span>
Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">140.25</span><span class="token punctuation">,</span> <span class="token number">36.12</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token punctuation">{</span>bands<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'B3'</span><span class="token punctuation">,</span> <span class="token string">'B2'</span><span class="token punctuation">,</span> <span class="token string">'B1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> min<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">randomVisualizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>GEEではkMeansという手法が実装されています。
ここでは50点のサンプル点を取り（30-34行目），その情報をもとに3クラスで学習をしています（37行目）。
その後40行目で分類をし，45行目で可視化しています。
randomVisualizer()メソッドはカラーパレットを適当に決めるときのメソッドです。</p> <p>結果は霞ヶ浦が分類されているカテゴリが水域で，森や畑地が同じカテゴリに分類され，都市などはその他のカテゴリとして分類されています。
ここで筑波山の斜面に着目すると，霞ヶ浦と同じカテゴリに分類されていることがわかります。
これは斜面が日影の影響で暗くなり，水面と類似した反射特性を示すためです。</p> <h1 id="教師あり分類"><a href="#教師あり分類" aria-hidden="true" class="header-anchor">#</a> 教師あり分類</h1> <p>次に教師あり分類を試してみます。
ここでは1:水域，2:都市,3:植生,4:その他として教師点を取得していきます。
教師点の取得はマーカーを用います。
マーカーは地図の左上のバルーンマークをクリックします。
クリックするとgeometryと書かれたウィンドウが追加されます。
geometryにカーソルを合わせると縦にびよっと伸び，geometryの右にカーソルを持っていくとギアマークが現れます。
このギアマークをクリックすると名前や色を変えることができます。
まずは水域の教師点を取りたいので，NameをWaterとし色を青色にしGeometryをFeatureCollectionにし，Add
propertyでnameをlandcover,valueを1と入力してOKを押します。
Sentinel-2の画像を参考にしながら水域と思われる箇所をポチポチクリックしていきます。
間違ってプロットしてしまった場合はバルーンの横の手のマークをクリックし，当該の地点をクリック
→ Deleteで削除できます。</p> <p>続いて都市の教師点を追加していきます。
Waterの文字にカーソルを合わせると+new
layerという文字が現れるのでクリックします。
先ほどと同様の手順で名前をUrban，色を赤色，GeometryをFeatureCollection，Propertyのnameをlandcover，valueを2にします。
植生はVegetationで緑色（value 3)，その他をOther(value
4)で黄色として同様に教師点を追加していきます。
アルゴリズムはランダムフォレストを使用し，カテゴリは4カテゴリとしました。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Load Sentinel-2 TOA reflectance data.</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'COPERNICUS/S2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Function to mask clouds using the Sentinel-2 QA band.</span>
<span class="token keyword">function</span> <span class="token function">maskS2clouds</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> qa <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'QA60'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Bits 10 and 11 are clouds and cirrus, respectively.</span>
  <span class="token keyword">var</span> cloudBitMask <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> cirrusBitMask <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Both flags should be set to zero, indicating clear conditions.</span>
  <span class="token keyword">var</span> mask <span class="token operator">=</span> qa<span class="token punctuation">.</span><span class="token function">bitwiseAnd</span><span class="token punctuation">(</span>cloudBitMask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>
             qa<span class="token punctuation">.</span><span class="token function">bitwiseAnd</span><span class="token punctuation">(</span>cirrusBitMask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the masked and scaled data.</span>
  <span class="token keyword">return</span> image<span class="token punctuation">.</span><span class="token function">updateMask</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Map the function over one year of data and take the median.</span>
<span class="token keyword">var</span> composite <span class="token operator">=</span> s2<span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span><span class="token string">'2016-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2016-12-31'</span><span class="token punctuation">)</span>
                  <span class="token comment">// Pre-filter to get less cloudy granules.</span>
                  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>ee<span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token string">'CLOUDY_PIXEL_PERCENTAGE'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>maskS2clouds<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">median</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  
<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">140.05</span><span class="token punctuation">,</span> <span class="token number">36.05</span><span class="token punctuation">,</span> <span class="token number">140.40</span><span class="token punctuation">,</span> <span class="token number">36.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> input <span class="token operator">=</span> composite<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Make the training dataset.</span>
<span class="token keyword">var</span> training <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  region<span class="token punctuation">:</span> roi<span class="token punctuation">,</span>
  scale<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  numPixels<span class="token punctuation">:</span> <span class="token number">50</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Cluster the input using the trained clusterer.</span>

<span class="token comment">// Display the results.</span>
Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">140.25</span><span class="token punctuation">,</span> <span class="token number">36.12</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token punctuation">{</span>bands<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'B3'</span><span class="token punctuation">,</span> <span class="token string">'B2'</span><span class="token punctuation">,</span> <span class="token string">'B1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> min<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">var</span> training_points <span class="token operator">=</span> Water<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>Urban<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>Vegetation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>Other<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bands <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'B1'</span><span class="token punctuation">,</span> <span class="token string">'B2'</span><span class="token punctuation">,</span> <span class="token string">'B3'</span><span class="token punctuation">,</span> <span class="token string">'B4'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> training <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sampleRegions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  collection<span class="token punctuation">:</span> training_points<span class="token punctuation">,</span> 
  properties<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'landcover'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  scale<span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> classifier <span class="token operator">=</span> ee<span class="token punctuation">.</span>Classifier<span class="token punctuation">.</span><span class="token function">randomForest</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  features<span class="token punctuation">:</span> training<span class="token punctuation">,</span> 
  classProperty<span class="token punctuation">:</span> <span class="token string">'landcover'</span><span class="token punctuation">,</span> 
  inputProperties<span class="token punctuation">:</span> bands<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> classified <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>classifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>classified<span class="token punctuation">,</span> <span class="token punctuation">{</span>min<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> palette<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'yellow'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre></div><h2 id="まとめ"><a href="#まとめ" aria-hidden="true" class="header-anchor">#</a> まとめ</h2> <h2 id="練習問題"><a href="#練習問題" aria-hidden="true" class="header-anchor">#</a> 練習問題</h2> <h2 id="コラム：大気補正・地形補正"><a href="#コラム：大気補正・地形補正" aria-hidden="true" class="header-anchor">#</a> コラム：大気補正・地形補正</h2> <h2 id="コラム：精度評価の話"><a href="#コラム：精度評価の話" aria-hidden="true" class="header-anchor">#</a> コラム：精度評価の話</h2></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/contents/google_earth_engine/chap05/" class="prev">
          第5章：夜間光の解析
        </a></span> <span class="next"><a href="/contents/google_earth_engine/chap07/">
          第7章：マイクロ波による解析
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/10.3b01200f.js" defer></script><script src="/assets/js/app.db0e00cd.js" defer></script>
  </body>
</html>
