<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第4章：植生指数の計算 | jkatagi&#39;s pages</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.aa6d0e5c.css" as="style"><link rel="preload" href="/assets/js/app.ba6bc741.js" as="script"><link rel="preload" href="/assets/js/2.762f5a7d.js" as="script"><link rel="preload" href="/assets/js/12.0cb459aa.js" as="script"><link rel="prefetch" href="/assets/js/10.cc6f5f8a.js"><link rel="prefetch" href="/assets/js/11.99be0be7.js"><link rel="prefetch" href="/assets/js/13.d42cd8fa.js"><link rel="prefetch" href="/assets/js/14.d4425937.js"><link rel="prefetch" href="/assets/js/15.db805892.js"><link rel="prefetch" href="/assets/js/16.6f36cdb1.js"><link rel="prefetch" href="/assets/js/17.e522cd46.js"><link rel="prefetch" href="/assets/js/18.64d286a0.js"><link rel="prefetch" href="/assets/js/19.5fe03e8e.js"><link rel="prefetch" href="/assets/js/20.f6869a3d.js"><link rel="prefetch" href="/assets/js/3.0bf6612a.js"><link rel="prefetch" href="/assets/js/4.df064526.js"><link rel="prefetch" href="/assets/js/5.cd0a6b0a.js"><link rel="prefetch" href="/assets/js/6.5342a429.js"><link rel="prefetch" href="/assets/js/7.22c0b50c.js"><link rel="prefetch" href="/assets/js/8.ce2a86eb.js"><link rel="prefetch" href="/assets/js/9.c8485083.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aa6d0e5c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">jkatagi's pages</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Contents" class="dropdown-title"><span class="title">Contents</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/contents/google_earth_engine/" class="nav-link router-link-active">
  Google Earth Engine入門-ゼロから始める衛星画像解析-
</a></li><li class="dropdown-item"><!----> <a href="/contents/about_research_in_college/" class="nav-link">
  About research in college
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jkatagi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Contents" class="dropdown-title"><span class="title">Contents</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/contents/google_earth_engine/" class="nav-link router-link-active">
  Google Earth Engine入門-ゼロから始める衛星画像解析-
</a></li><li class="dropdown-item"><!----> <a href="/contents/about_research_in_college/" class="nav-link">
  About research in college
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jkatagi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第4章：植生指数の計算</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/contents/google_earth_engine/chap04/#ndviとは" class="sidebar-link">NDVIとは</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/contents/google_earth_engine/chap04/#東南アジアの森林事情" class="sidebar-link">東南アジアの森林事情</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/contents/google_earth_engine/chap04/#ndviの計算（一枚の場合）" class="sidebar-link">NDVIの計算（一枚の場合）</a></li><li class="sidebar-sub-header"><a href="/contents/google_earth_engine/chap04/#ndviの計算（複数枚の場合）" class="sidebar-link">NDVIの計算（複数枚の場合）</a></li><li class="sidebar-sub-header"><a href="/contents/google_earth_engine/chap04/#uiツールを用いたndviトレンドの確認" class="sidebar-link">UIツールを用いたNDVIトレンドの確認</a></li></ul></li><li><a href="/contents/google_earth_engine/chap04/#まとめ" class="sidebar-link">まとめ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/contents/google_earth_engine/chap04/#練習問題" class="sidebar-link">練習問題</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/contents/google_earth_engine/chap04/#コラム：ndviは本当に植物の分布を表せるのか" class="sidebar-link">コラム：NDVIは本当に植物の分布を表せるのか</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第4章：植生指数の計算"><a href="#第4章：植生指数の計算" class="header-anchor">#</a> 第4章：植生指数の計算</h1> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css"> <p>本章では植物の状態を表す指標の1つである，正規化植生指数（Normalized
Difference Vegetation Index; NDVI）を計算します。
またNDVIを地図に表示することによって，各地域の植物分布をざっくり把握してみます。</p> <h2 id="ndviとは"><a href="#ndviとは" class="header-anchor">#</a> NDVIとは</h2> <p>前章では様々な衛星画像を表示させました。
その中でナチュラルカラー・フォールスカラーという色の組み合わせで植物を強調して表示する手法を学びました。
これらの概念は植物が強く反射する近赤外の反射率を特定の色の表示に割り当てることにより、植物を強調して示するというものでした。
この植物の「近赤外の波長の光を反射し、赤色の波長の光を吸収する」という特性に着目し、以下のNDVIという指標が一般的に用いられています(<a href="https://www.sciencedirect.com/science/article/pii/0034425779900130" target="_blank" rel="noopener noreferrer">Tucker, 1979<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</p> <p>$$NDVI = \frac{NIR - R}{NIR + R}$$</p> <p>ここで$NIR:$近赤外の反射率、$R:$赤色の反射率です。
NDVIは上の式から-1から+1までの値を取り、また+1に近いほど植物が多いことを表しています。</p> <h2 id="東南アジアの森林事情"><a href="#東南アジアの森林事情" class="header-anchor">#</a> 東南アジアの森林事情</h2> <p>ここからは東南アジアの森林事情をNDVIを用いて見ていきます。
東南アジアでは近年森林伐採が叫ばれ、希少生物の保全や地球環境の観点から植物の分布を知ることは重要です。
さてここで皆さんに一つ問題を出します。
近年発展が著しい中国では、ここ20年で植生が増えているでしょうか、減っているでしょうか。
その答えをNDVIを通じて探ってみましょう。</p> <p>この問題に取り組んだ論文として(<a href="https://www.jstage.jst.go.jp/article/rssj/28/1/28_1_36/_article" target="_blank" rel="noopener noreferrer">小柳ら, 2008<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)があります。
論文では2000年から2005年までの間の植生の変化を，SPOT/VegitatoinとTerra/MODISの２つの衛星を用いて，それぞれ独立に解析を行って植生の動向を追っています。
まずはじめにこの論文の手法をGEEで実際に実装してみます。
次にこの論文の解析対象より後の衛星画像（2005年以降の衛星画像）も追加して解析を行ってみます。</p> <p>さて熱帯・亜熱帯地方を解析する場合に避けて通れない問題として雲があります。
光学センサではその特性から雲を透過することはできないため，雲が多いと地上の様子をほとんど得ることができません。
上記の論文では8日間あるいは10日間で晴天時と思われる部分をつなぎ合わせる処理（これをコンポジットと言います）が施された画像を用い，
さらにそこから年間の最大のNDVIを抽出するという処理をしています。
これに習って実際にコードを書いてみましょう。</p> <h3 id="ndviの計算（一枚の場合）"><a href="#ndviの計算（一枚の場合）" class="header-anchor">#</a> NDVIの計算（一枚の場合）</h3> <p>まずはじめに2005年のMODIS画像を一枚表示させてみましょう。
論文と同じく8日間コンポジットのMOD09A1プロダクトを使用します。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> start <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> finish <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-12-31'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> images <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'MODIS/006/MOD09A1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> finish<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment">// need to cast as ee.Image</span>
<span class="token keyword">var</span> image <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Image</span><span class="token punctuation">(</span>images<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>roiはRegion of
interesetの略で、ee.Geometry.Rectangle()で四角形で指定しています。
指定した領域で画像を切り出す処理はMap.addLayer()内のimage.clip(roi)で行っています。
また今回は試しに一枚の画像を表示させるために、ee.ImageCollectionのインスタンス（images）に対して.first()メソッドを呼び出しています。
このメソッドはee.ImageCollectionの一番初めの画像を取り出します。
なおfirst()の返り値（関数呼び出しによって返される値）はElement型というものなので、そのままではMap.addLayer()で表示できません。
そのためee.Image()で囲むことによって型をee.Image型に変換させています。
このスクリプトを走らせるとroiの範囲で切りだされた画像が表示されるかと思います。</p> <a href="/chap04/ndvi1.png" target="_blank"><img src="/chap04/ndvi1.png" alt=""></a> <p>ここから実際にNDVIの計算をしてみましょう。
まずはじめにMOD09A1における赤・近赤外の波長に対応するバンドを調べます。
SearchにMOD09A1と入力し、確認するとsur_refl_b01が赤色（red）でsur_refl_b02が近赤外（Near
Infra Red; nir)であることが分かります。
あるバンドに対して何かしらの処理を行い時はee.Image.select()メソッドを使います。
それでは赤・近赤外のバンドを実際に変数として指定してみましょう。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> red <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nir <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>続いて指定したバンドに対して引き算・足し算を行います。
それにはee.Image.subtract()・ee.Image.add()メソッドを使います。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// (NIR - R)</span>
<span class="token keyword">var</span> nir_minus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// (NIR + R)</span>
<span class="token keyword">var</span> nir_plus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最後にそれらを割り算します。 これはee.Image.divide()メソッドを使います。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// (NIR - R) / (NIR + R)</span>
<span class="token keyword">var</span> ndvi <span class="token operator">=</span> nir_minus_red<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>nir_plus_red<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;NDVI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>割り算の結果（NDVI）に対してrename()メソッドを用いて“NDVI”というバンド名を割り当てています。
では実際に計算結果を表示させてみましょう。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>カラーパレットを割り当てていないので、NDVIが高いところは白っぽく、NDVIが低いところは黒っぽく表示されています。
論文では最小値0から最大値1.0まで青・黄色・赤の順に割り当てていたので、それに合わせせ色を変えてみます。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> visParams <span class="token operator">=</span> <span class="token punctuation">{</span>
  bands<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'NDVI'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  min<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span> max<span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span> 
  palette<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'0000FF'</span><span class="token punctuation">,</span> <span class="token string">'FFFF00'</span><span class="token punctuation">,</span> <span class="token string">'FF0000'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span> visParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><a href="/chap04/ndvi2.png" target="_blank"><img src="/chap04/ndvi2.png" alt=""></a> <p>日本に着目してみると、全体的に青みがかかっていると思います。
この部分は雲に覆われてしまっていることによるものです。</p> <p>ここまでの処理をまとめたスクリプトが以下です。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> start <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> finish <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-12-31'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> images <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'MODIS/006/MOD09A1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> finish<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment">// need to cast as ee.Image</span>
<span class="token keyword">var</span> image <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Image</span><span class="token punctuation">(</span>images<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> red <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nir <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// (NIR - R)</span>
<span class="token keyword">var</span> nir_minus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// (NIR + R)</span>
<span class="token keyword">var</span> nir_plus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// (NIR - R) / (NIR + R)</span>
<span class="token keyword">var</span> ndvi <span class="token operator">=</span> nir_minus_red<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>nir_plus_red<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;NDVI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> visParams <span class="token operator">=</span> <span class="token punctuation">{</span>
  bands<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'NDVI'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  min<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span> max<span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span> 
  palette<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'0000FF'</span><span class="token punctuation">,</span> <span class="token string">'FFFF00'</span><span class="token punctuation">,</span> <span class="token string">'FF0000'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span> visParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="ndviの計算（複数枚の場合）"><a href="#ndviの計算（複数枚の場合）" class="header-anchor">#</a> NDVIの計算（複数枚の場合）</h3> <p>NDVIの計算の実装方法が分かったので、今度は複数枚に対してNDVIを計算します。</p> <p>先ほどのように一枚一枚に対して以下のコードを実行すれば、複数枚に対してNDVIを求めることが出来ます（一枚目をimage1、二枚目をimage2、…とします）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> red1 <span class="token operator">=</span> image1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nir1 <span class="token operator">=</span> image1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">var</span> nir_minus_red <span class="token operator">=</span> nir1<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>red1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nir_plus_red <span class="token operator">=</span> nir1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>red1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi1 <span class="token operator">=</span> nir_minus_red<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>nir_plus_red<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;NDVI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">var</span> red2 <span class="token operator">=</span> image2<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nir2 <span class="token operator">=</span> image2<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">var</span> nir_minus_red <span class="token operator">=</span> nir2<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>red2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nir_plus_red <span class="token operator">=</span> nir2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>red2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi2 <span class="token operator">=</span> nir_minus_red<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>nir_plus_red<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;NDVI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
</code></pre></div><p>しかしながら画像が100枚あった場合には100回同じ処理を書かなければならず、あまりにも非効率です。
このように同じ処理を施す場合には関数を定義して利用すると便利です。
もう一度NDVIを求める部分のコードを見てみましょう。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> red <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nir <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// (NIR - R)</span>
<span class="token keyword">var</span> nir_minus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// (NIR + R)</span>
<span class="token keyword">var</span> nir_plus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// (NIR - R) / (NIR + R)</span>
<span class="token keyword">var</span> ndvi <span class="token operator">=</span> nir_minus_red<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>nir_plus_red<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;NDVI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>このコードを見ると、imageの部分のみが変わってそれ以外は画像ごとに変わらない処理ということが分かります。
そこでimageを引数として受け取ってndviを返す関数を定義します。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">calc_MODIS_NDVI</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> red <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nir <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR - R)</span>
  <span class="token keyword">var</span> nir_minus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR + R)</span>
  <span class="token keyword">var</span> nir_plus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR - R) / (NIR + R)</span>
  <span class="token keyword">var</span> ndvi <span class="token operator">=</span> nir_minus_red<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>nir_plus_red<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;NDVI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ndvi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>関数の名前はcalc_MODIS_NDVIとしました。
一枚の画像に対してNDVIを求めるコードを関数を用いて書き直したのが以下のコードです。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> start <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> finish <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-12-31'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> images <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'MODIS/006/MOD09A1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> finish<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment">// need to cast as ee.Image</span>
<span class="token keyword">var</span> image <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Image</span><span class="token punctuation">(</span>images<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">calc_MODIS_NDVI</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> red <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nir <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR - R)</span>
  <span class="token keyword">var</span> nir_minus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR + R)</span>
  <span class="token keyword">var</span> nir_plus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR - R) / (NIR + R)</span>
  <span class="token keyword">var</span> ndvi <span class="token operator">=</span> nir_minus_red<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>nir_plus_red<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;NDVI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ndvi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> ndvi <span class="token operator">=</span> <span class="token function">calc_MODIS_NDVI</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>

Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> visParams <span class="token operator">=</span> <span class="token punctuation">{</span>
  bands<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'NDVI'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  min<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span> max<span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span> 
  palette<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'0000FF'</span><span class="token punctuation">,</span> <span class="token string">'FFFF00'</span><span class="token punctuation">,</span> <span class="token string">'FF0000'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span> visParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>実行結果は関数を用いない場合と同じになります（このように処理の結果を変えずに中身を書き換えることをリファクタリングといいます）。
関数が無事実装出来たことを確認したので、いよいよ複数枚に対してNDVIを計算していきます。
GEEでは、複数枚に対してある関数を適用するときにee.ImageCollection.map()メソッドを使います。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> ndvi_series <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>calc_MODIS_NDVI<span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi_series<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Inspectorタブをクリックしてから適当な場所を地図上でクリックし、PixelsのSeriesをクリックするとキチンと複数枚のNDVIを計算できていることが分かります。
論文では一年間のうちの最大値のNDVIを解析に使用しているので、それに習います。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> ndvi_series <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>calc_MODIS_NDVI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi_max <span class="token operator">=</span> ndvi_series<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi_max<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span> visParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>NDVIの最大値を可視化できましたが、どうも海の部分の見た目が良くないです。
今回の解析では陸地のみを対象としているので、海は取り除いてしまいましょう。
人工衛星の分野では、何かしらの画像を重ねあわせて取り除く処理をマスク処理といいます。</p> <p>今回は海の部分を取り除きたいので、標高が0
m以下の部分を陸地として、陸地でマスクを行います。
標高データは第二章で用いたGTOPO30を用います。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> elev <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Image</span><span class="token punctuation">(</span><span class="token string">'USGS/GTOPO30'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> land <span class="token operator">=</span> elev<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if elevation is greater than 0 m, then true (land) else false (sea).</span>
</code></pre></div><p>マスクの適用はee.Image.updateMask()メソッドを用います。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> ndvi_series <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>calc_MODIS_NDVI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi_max <span class="token operator">=</span> ndvi_series<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi_max_land <span class="token operator">=</span> ndvi_max<span class="token punctuation">.</span><span class="token function">updateMask</span><span class="token punctuation">(</span>land<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>マスク処理を行うとtrueの箇所のみ表示される（すなわち陸地のみ表示される）ことになります。
ここまでの処理をまとめたスクリプトが以下です。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> start <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> finish <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-12-31'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> elev <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Image</span><span class="token punctuation">(</span><span class="token string">'USGS/GTOPO30'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> land <span class="token operator">=</span> elev<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if elevation is greater than 0 m, then true (land) else false (sea).  </span>

<span class="token keyword">var</span> images <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'MODIS/006/MOD09A1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> finish<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">calc_MODIS_NDVI</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> red <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nir <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR - R)</span>
  <span class="token keyword">var</span> nir_minus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR + R)</span>
  <span class="token keyword">var</span> nir_plus_red <span class="token operator">=</span> nir<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// (NIR - R) / (NIR + R)</span>
  <span class="token keyword">var</span> ndvi <span class="token operator">=</span> nir_minus_red<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>nir_plus_red<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;NDVI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ndvi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> ndvi_series <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>calc_MODIS_NDVI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi_max <span class="token operator">=</span> ndvi_series<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi_max_land <span class="token operator">=</span> ndvi_max<span class="token punctuation">.</span><span class="token function">updateMask</span><span class="token punctuation">(</span>land<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">var</span> visParams <span class="token operator">=</span> <span class="token punctuation">{</span>
  bands<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'NDVI'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  min<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span> max<span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span> 
  palette<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'0000FF'</span><span class="token punctuation">,</span> <span class="token string">'FFFF00'</span><span class="token punctuation">,</span> <span class="token string">'FF0000'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi_max_land<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span> visParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ちなみにndviの計算部分はee.Image.normalizedDifference()メソッドを用いると更に簡潔に書くことが出来ます。
今回は説明のため周りくどい書き方をしていました。
リファクタリングした結果が以下です。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> start <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> finish <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-12-31'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> elev <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Image</span><span class="token punctuation">(</span><span class="token string">'USGS/GTOPO30'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> land <span class="token operator">=</span> elev<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if elevation is greater than 0 m, then true (land) else false (sea).  </span>

<span class="token keyword">var</span> images <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'MODIS/006/MOD09A1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> finish<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">calc_MODIS_NDVI</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// (NIR - R) / (NIR + R)</span>
  <span class="token keyword">var</span> ndvi <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">normalizedDifference</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">,</span> <span class="token string">'sur_refl_b01'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">'NDVI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ndvi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> ndvi_series <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>calc_MODIS_NDVI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi_max <span class="token operator">=</span> ndvi_series<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi_max_land <span class="token operator">=</span> ndvi_max<span class="token punctuation">.</span><span class="token function">updateMask</span><span class="token punctuation">(</span>land<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">var</span> visParams <span class="token operator">=</span> <span class="token punctuation">{</span>
  bands<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'NDVI'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  min<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span> max<span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span> 
  palette<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'0000FF'</span><span class="token punctuation">,</span> <span class="token string">'FFFF00'</span><span class="token punctuation">,</span> <span class="token string">'FF0000'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi_max_land<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span> visParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><a href="/chap04/ndvi3.png" target="_blank"><img src="/chap04/ndvi3.png" alt=""></a> <h3 id="uiツールを用いたndviトレンドの確認"><a href="#uiツールを用いたndviトレンドの確認" class="header-anchor">#</a> UIツールを用いたNDVIトレンドの確認</h3> <p>論文ではこの後2000年から2005年までの各年に対してNDVIの年間最大値を求め、回帰直線を引いてその傾きを地図上にプロットしていました。
これは練習問題に回すとして、GEEのUIツールというものを用いてNDVIトレンドを確認してみましょう
（以下のコードのMap.onClick()は<a href="https://events.withgoogle.com/earthengineminisummit2018tyo/#content" target="_blank" rel="noopener noreferrer">GoogeEarthEngine 2018 Tokyo minisumit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>の<a href="https://code.earthengine.google.com/?accept_repo=users/nclinton/ui-api-101" target="_blank" rel="noopener noreferrer">コード<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をベースに一部変更を加えたものです）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> start <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2005-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> finish <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token string">'2010-12-31'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> roi <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> images <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">ImageCollection</span><span class="token punctuation">(</span><span class="token string">'MODIS/006/MOD09A1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filterDate</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> finish<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">function</span> <span class="token function">calc_MODIS_NDVI</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// (NIR - R) / (NIR + R)</span>
  <span class="token keyword">var</span> ndvi <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">normalizedDifference</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'sur_refl_b02'</span><span class="token punctuation">,</span> <span class="token string">'sur_refl_b01'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">'NDVI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">var</span> elev <span class="token operator">=</span> ee<span class="token punctuation">.</span><span class="token function">Image</span><span class="token punctuation">(</span><span class="token string">'USGS/GTOPO30'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> land <span class="token operator">=</span> elev<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if elevation is greater than 0 m, then true (land) else false (sea).  </span>
  
  <span class="token keyword">return</span> image<span class="token punctuation">.</span><span class="token function">addBands</span><span class="token punctuation">(</span>ndvi<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateMask</span><span class="token punctuation">(</span>land<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> ndvi_land <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>calc_MODIS_NDVI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ndvi_max_land <span class="token operator">=</span> ndvi_land<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// from 2005 to 2010</span>

<span class="token keyword">var</span> visParams <span class="token operator">=</span> <span class="token punctuation">{</span>
  bands<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'NDVI'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  min<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span> max<span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span> 
  palette<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'0000FF'</span><span class="token punctuation">,</span> <span class="token string">'FFFF00'</span><span class="token punctuation">,</span> <span class="token string">'FF0000'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Create and style widgets.</span>
<span class="token keyword">var</span> intro <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Panel</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  ui<span class="token punctuation">.</span><span class="token function">Label</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    value<span class="token operator">:</span> <span class="token string">'NDVI Inspector'</span><span class="token punctuation">,</span>
    style<span class="token operator">:</span> <span class="token punctuation">{</span>fontSize<span class="token operator">:</span> <span class="token string">'20px'</span><span class="token punctuation">,</span> fontWeight<span class="token operator">:</span> <span class="token string">'bold'</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  ui<span class="token punctuation">.</span><span class="token function">Label</span><span class="token punctuation">(</span><span class="token string">'Click a point on the map to inspect NDVI over time.'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> lon <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> lat <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Add the widgets to a new panel.</span>
<span class="token keyword">var</span> panel <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Panel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
panel<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>intro<span class="token punctuation">)</span><span class="token punctuation">;</span>
panel<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>lon<span class="token punctuation">)</span><span class="token punctuation">;</span>
panel<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>lat<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Add the new panel to the root panel.</span>
ui<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> panel<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setup the map.</span>
Map<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>ndvi_max_land<span class="token punctuation">,</span> visParams<span class="token punctuation">)</span><span class="token punctuation">;</span>

Map<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">coords</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  lon<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">'lon: '</span> <span class="token operator">+</span> coords<span class="token punctuation">.</span>lon<span class="token punctuation">)</span><span class="token punctuation">;</span>
  lat<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">'lat: '</span> <span class="token operator">+</span> coords<span class="token punctuation">.</span>lat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Add a red point to the map wherever the user clicks.</span>
  <span class="token keyword">var</span> point <span class="token operator">=</span> ee<span class="token punctuation">.</span>Geometry<span class="token punctuation">.</span><span class="token function">Point</span><span class="token punctuation">(</span>coords<span class="token punctuation">.</span>lon<span class="token punctuation">,</span> coords<span class="token punctuation">.</span>lat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> dot <span class="token operator">=</span> ui<span class="token punctuation">.</span>Map<span class="token punctuation">.</span><span class="token function">Layer</span><span class="token punctuation">(</span>point<span class="token punctuation">,</span> <span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Map<span class="token punctuation">.</span><span class="token function">layers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Add an NDVI chart.</span>
  <span class="token keyword">var</span> chart <span class="token operator">=</span> ui<span class="token punctuation">.</span>Chart<span class="token punctuation">.</span>image<span class="token punctuation">.</span><span class="token function">series</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imageCollection<span class="token operator">:</span> ndvi_land<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'NDVI'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    region<span class="token operator">:</span> point<span class="token punctuation">,</span> 
    reducer<span class="token operator">:</span> ee<span class="token punctuation">.</span>Reducer<span class="token punctuation">.</span><span class="token function">mean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    scale<span class="token operator">:</span> <span class="token number">250</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  chart<span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'NDVI Over Time'</span><span class="token punctuation">,</span>
    vAxis<span class="token operator">:</span> <span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">'NDVI'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    hAxis<span class="token operator">:</span> <span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">'date'</span><span class="token punctuation">,</span> format<span class="token operator">:</span> <span class="token string">'MM-yy'</span><span class="token punctuation">,</span> gridlines<span class="token operator">:</span> <span class="token punctuation">{</span>count<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    interpolateNulls<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  panel<span class="token punctuation">.</span><span class="token function">widgets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> chart<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Map<span class="token punctuation">.</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'cursor'</span><span class="token punctuation">,</span> <span class="token string">'crosshair'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>どこか適当な場所をクリックすると、マップの横に時系列NDVIのチャートが表示されるかと思います。
論文で取り上げられているN36°16′34″E110°45′16″(＝N36.276E110.754)の付近クリックし、実際にNDVIが増加しているかを調べてみましょう。</p> <a href="/chap04/ndvi4.png" target="_blank"><img src="/chap04/ndvi4.png" alt=""></a> <h2 id="まとめ"><a href="#まとめ" class="header-anchor">#</a> まとめ</h2> <p>本章では論文の手法を再実装することで東南アジアの植生分布の時系列変化を見てきました。
（書きかけ）</p> <h2 id="練習問題"><a href="#練習問題" class="header-anchor">#</a> 練習問題</h2> <ol><li>論文のように2000年から2005年までの各年に対してNDVIの年間最大値を求め、回帰直線を引いてその傾きをピクセルごとに求めてみましょう。また求めた値をプロットしてみましょう。</li></ol> <h2 id="コラム：ndviは本当に植物の分布を表せるのか"><a href="#コラム：ndviは本当に植物の分布を表せるのか" class="header-anchor">#</a> コラム：NDVIは本当に植物の分布を表せるのか</h2> <p>（書きかけ）</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/contents/google_earth_engine/chap03/" class="prev">
        第3章：衛星画像の表示
      </a></span> <span class="next"><a href="/contents/google_earth_engine/chap05/">
        第5章：夜間光の解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ba6bc741.js" defer></script><script src="/assets/js/2.762f5a7d.js" defer></script><script src="/assets/js/12.0cb459aa.js" defer></script>
  </body>
</html>
